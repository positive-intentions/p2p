"use strict";(self.webpackChunkp2p=self.webpackChunkp2p||[]).push([[200],{"./src/stories/PeerProvider.stories.js":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{function _define_property(obj,key,value){return key in obj?Object.defineProperty(obj,key,{value,enumerable:!0,configurable:!0,writable:!0}):obj[key]=value,obj}function _object_spread(target){for(var i=1;i<arguments.length;i++){var source=null!=arguments[i]?arguments[i]:{},ownKeys=Object.keys(source);"function"==typeof Object.getOwnPropertySymbols&&(ownKeys=ownKeys.concat(Object.getOwnPropertySymbols(source).filter((function(sym){return Object.getOwnPropertyDescriptor(source,sym).enumerable})))),ownKeys.forEach((function(key){_define_property(target,key,source[key])}))}return target}function _object_spread_props(target,source){return source=null!=source?source:{},Object.getOwnPropertyDescriptors?Object.defineProperties(target,Object.getOwnPropertyDescriptors(source)):function ownKeys(object,enumerableOnly){var keys=Object.keys(object);if(Object.getOwnPropertySymbols){var symbols=Object.getOwnPropertySymbols(object);enumerableOnly&&(symbols=symbols.filter((function(sym){return Object.getOwnPropertyDescriptor(object,sym).enumerable}))),keys.push.apply(keys,symbols)}return keys}(Object(source)).forEach((function(key){Object.defineProperty(target,key,Object.getOwnPropertyDescriptor(source,key))})),target}__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,{Basic:()=>Basic,__namedExportsOrder:()=>__namedExportsOrder,default:()=>__WEBPACK_DEFAULT_EXPORT__});const __WEBPACK_DEFAULT_EXPORT__={title:"Components/PeerProvider",component:__webpack_require__("./src/stories/components/PeerProvider.tsx").A,parameters:{layout:"centered"},tags:["autodocs"]};var randomValues=crypto.getRandomValues(new Uint8Array(16)),appiSchema={ping:function(state,actions){return[function(request,response,next){console.log("ping received"),response.send({message:"pong"})}]},addNumber:function(state,actions){return[function(request,response,next){var number=request.number;actions.addNumber(number)(state,actions.setState),console.log("Number updated to",state.number),response.send({number:state.number})}]},getNumber:function(state,actions){return[function(request,response,next){response.send({number:state.number})}]}},actions={addNumber:function(number){return function(_,setState){setState((function(prevState){return _object_spread_props(_object_spread({},prevState),{number:prevState.number+number})}))}}},Basic={args:{contactId:"",children:"positive-intentions",peerId:Array.from(randomValues).map((function(byte){return byte.toString(16).padStart(2,"0")})).join(""),config:{},contacts:[""],appiSchema,state:_object_spread({},{number:0}),actions,onConnection:function(conn){console.log("connectied to peer")}}};Basic.parameters={...Basic.parameters,docs:{...Basic.parameters?.docs,source:{originalSource:'{\n  args: {\n    contactId: "",\n    children: "positive-intentions",\n    peerId: randomHex,\n    config: {},\n    contacts,\n    appiSchema,\n    state: {\n      ...state\n    },\n    actions,\n    onConnection: conn => {\n      console.log("connectied to peer");\n    }\n  }\n}',...Basic.parameters?.docs?.source}}};const __namedExportsOrder=["Basic"]},"./src/stories/components/PeerProvider.tsx":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{A:()=>PeerProvider});var react__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("./node_modules/react/index.js"),peerjs__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__("./node_modules/peerjs/dist/bundler.mjs"),dim_Dim__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__("webpack/container/remote/dim/Dim");function _array_like_to_array(arr,len){(null==len||len>arr.length)&&(len=arr.length);for(var i=0,arr2=new Array(len);i<len;i++)arr2[i]=arr[i];return arr2}function _define_property(obj,key,value){return key in obj?Object.defineProperty(obj,key,{value,enumerable:!0,configurable:!0,writable:!0}):obj[key]=value,obj}function _object_spread(target){for(var i=1;i<arguments.length;i++){var source=null!=arguments[i]?arguments[i]:{},ownKeys=Object.keys(source);"function"==typeof Object.getOwnPropertySymbols&&(ownKeys=ownKeys.concat(Object.getOwnPropertySymbols(source).filter((function(sym){return Object.getOwnPropertyDescriptor(source,sym).enumerable})))),ownKeys.forEach((function(key){_define_property(target,key,source[key])}))}return target}function _object_spread_props(target,source){return source=null!=source?source:{},Object.getOwnPropertyDescriptors?Object.defineProperties(target,Object.getOwnPropertyDescriptors(source)):function ownKeys(object,enumerableOnly){var keys=Object.keys(object);if(Object.getOwnPropertySymbols){var symbols=Object.getOwnPropertySymbols(object);enumerableOnly&&(symbols=symbols.filter((function(sym){return Object.getOwnPropertyDescriptor(object,sym).enumerable}))),keys.push.apply(keys,symbols)}return keys}(Object(source)).forEach((function(key){Object.defineProperty(target,key,Object.getOwnPropertyDescriptor(source,key))})),target}function _sliced_to_array(arr,i){return function _array_with_holes(arr){if(Array.isArray(arr))return arr}(arr)||function _iterable_to_array_limit(arr,i){var _i=null==arr?null:"undefined"!=typeof Symbol&&arr[Symbol.iterator]||arr["@@iterator"];if(null!=_i){var _s,_e,_arr=[],_n=!0,_d=!1;try{for(_i=_i.call(arr);!(_n=(_s=_i.next()).done)&&(_arr.push(_s.value),!i||_arr.length!==i);_n=!0);}catch(err){_d=!0,_e=err}finally{try{_n||null==_i.return||_i.return()}finally{if(_d)throw _e}}return _arr}}(arr,i)||_unsupported_iterable_to_array(arr,i)||function _non_iterable_rest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function _to_consumable_array(arr){return function _array_without_holes(arr){if(Array.isArray(arr))return _array_like_to_array(arr)}(arr)||function _iterable_to_array(iter){if("undefined"!=typeof Symbol&&null!=iter[Symbol.iterator]||null!=iter["@@iterator"])return Array.from(iter)}(arr)||_unsupported_iterable_to_array(arr)||function _non_iterable_spread(){throw new TypeError("Invalid attempt to spread non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function _unsupported_iterable_to_array(o,minLen){if(o){if("string"==typeof o)return _array_like_to_array(o,minLen);var n=Object.prototype.toString.call(o).slice(8,-1);return"Object"===n&&o.constructor&&(n=o.constructor.name),"Map"===n||"Set"===n?Array.from(n):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?_array_like_to_array(o,minLen):void 0}}function _templateObject(){var data=function _tagged_template_literal(strings,raw){return raw||(raw=strings.slice(0)),Object.freeze(Object.defineProperties(strings,{raw:{value:Object.freeze(raw)}}))}(['\n        <button @click="','">\n            ',"\n            ","\n            ","\n        </button>\n    "]);return _templateObject=function _templateObject(){return data},data}(0,dim_Dim__WEBPACK_IMPORTED_MODULE_1__.define)({tag:"my-button",component:function Button(param){var children=param.children,_param_initialstate=param.initialstate,initialstate=void 0===_param_initialstate?0:_param_initialstate,_useState2=_sliced_to_array((0,dim_Dim__WEBPACK_IMPORTED_MODULE_1__.useState)(parseInt(initialstate)),2),count=_useState2[0],setCount=_useState2[1];(0,dim_Dim__WEBPACK_IMPORTED_MODULE_1__.useEffect)((function(){return console.log("Button mounted"),function(){console.log("Button unmounted")}}),[]),(0,dim_Dim__WEBPACK_IMPORTED_MODULE_1__.useEffect)((function(){console.log("count effect triggered")}),[count()]);var someCalculation=(0,dim_Dim__WEBPACK_IMPORTED_MODULE_1__.useMemo)((function(){var result=2*count();return console.log("memo calculation triggered:",result),result}),[count()]);return(0,dim_Dim__WEBPACK_IMPORTED_MODULE_1__.html)(_templateObject(),(function(){return setCount(count()+1)}),children,count(),someCalculation)}});var PeerContext=(0,react__WEBPACK_IMPORTED_MODULE_0__.createContext)();function PeerProvider(param){var peerId=param.peerId,contacts=(param.config,param.contacts),contactId=param.contactId,appiSchema=param.appiSchema,initialState=param.state,contentHash=param.contentHash,actions=param.actions,onConnection=param.onConnection,children=param.children,_useState=_sliced_to_array((0,react__WEBPACK_IMPORTED_MODULE_0__.useState)(null),2),peer=_useState[0],setPeer=_useState[1],_useState1=_sliced_to_array((0,react__WEBPACK_IMPORTED_MODULE_0__.useState)({}),2),connections=_useState1[0],setConnections=_useState1[1],_useState2=_sliced_to_array((0,react__WEBPACK_IMPORTED_MODULE_0__.useState)({}),2),streams=_useState2[0],_useState3=(_useState2[1],_sliced_to_array((0,react__WEBPACK_IMPORTED_MODULE_0__.useState)(initialState),2)),state=_useState3[0],setState=_useState3[1],allContacts=(0,dim_Dim__WEBPACK_IMPORTED_MODULE_1__.useMemo)((function(){return _to_consumable_array(contacts).concat([contactId||null]).filter((function(c){return!!c}))}),[JSON.stringify(contacts),contactId]);(0,react__WEBPACK_IMPORTED_MODULE_0__.useEffect)((function(){if(peerId&&!peer||(null==peer?void 0:peer.id)&&peer.id!==peerId){var newPeer=new peerjs__WEBPACK_IMPORTED_MODULE_2__.Ay(peerId);handlePeerInitialisation(newPeer)}else peerId||(peer.destroy(),setPeer(null))}),[peerId,peer]);var handlePeerInitialisation=function(newPeer){newPeer.on("open",(function(){console.log("Peer connected with ID:",newPeer.id),setPeer(newPeer),connectToContacts(newPeer)})),newPeer.on("disconnected",(function(){console.log("Peer disconnected"),newPeer.reconnect()})),newPeer.on("connection",(function(conn){console.log("Received connection from",conn.peer),setupConnectionHandler(conn)})),newPeer.on("close",(function(){console.log("Peer connection closed"),setPeer(null)})),newPeer.on("error",(function(err){console.error("Peer error:",err),console.log({err});var newConnections=_object_spread({},connections);Object.keys(newConnections).forEach((function(key){!1===newConnections[key].open&&delete newConnections[key]})),setConnections(newConnections)}))},setupConnectionHandler=(0,react__WEBPACK_IMPORTED_MODULE_0__.useCallback)((function(conn){try{conn.off("data")}catch(err){console.log("error removing data listener",err)}conn.on("data",(function(data){return handleData(conn,data)})),conn.on("open",(function(){onConnection&&onConnection(conn)})),conn.on("close",(function(){console.log("Connection ".concat(conn.peer," closed")),setConnections((function(prev){var updated=_object_spread({},prev);return delete updated[conn.peer],updated}))})),setConnections((function(prev){return _object_spread_props(_object_spread({},prev),_define_property({},conn.peer,conn))}))}),[onConnection,state,contentHash]),handleData=(0,react__WEBPACK_IMPORTED_MODULE_0__.useCallback)((function(conn,data){data.type&&appiSchema[data.type]&&appiSchema[data.type](state,_object_spread_props(_object_spread({},actions),{setState:function(updater){return setState((function(prevState){return"function"==typeof updater?updater(prevState):_object_spread({},prevState,updater)}))}})).forEach((function(handler){handler(_object_spread({},data),{send:function(response){return conn.send(response)}},(function(){}))}))}),[appiSchema,state,actions]),connectToContacts=(0,react__WEBPACK_IMPORTED_MODULE_0__.useCallback)((function(peer){allContacts.filter((function(contact){return!!contact})).forEach((function(contact){if(!connections[contact]){console.log("connecting to",contact,"...");var conn=peer.connect(contact);setupConnectionHandler(conn)}}))}),[allContacts,connections,setupConnectionHandler]);return(0,react__WEBPACK_IMPORTED_MODULE_0__.useEffect)((function(){allContacts.length>0&&peer&&connectToContacts(peer)}),[JSON.stringify(allContacts),peer]),react__WEBPACK_IMPORTED_MODULE_0__.createElement(PeerContext.Provider,{value:{peer,emit:handleData,call:setupConnectionHandler,streams,connections}},"my peer id: ",peerId,react__WEBPACK_IMPORTED_MODULE_0__.createElement("br",null),react__WEBPACK_IMPORTED_MODULE_0__.createElement("br",null),"peerjs: ",peer?"connected":"disconnected",react__WEBPACK_IMPORTED_MODULE_0__.createElement("br",null),react__WEBPACK_IMPORTED_MODULE_0__.createElement("br",null),"counter: ",JSON.stringify(state.number),react__WEBPACK_IMPORTED_MODULE_0__.createElement("br",null),react__WEBPACK_IMPORTED_MODULE_0__.createElement("br",null),"connections:",react__WEBPACK_IMPORTED_MODULE_0__.createElement("ol",null,Object.keys(connections).map((function(key){return react__WEBPACK_IMPORTED_MODULE_0__.createElement("li",{key},key,react__WEBPACK_IMPORTED_MODULE_0__.createElement("input",{type:"button",value:"ping",onClick:function(){return connections[key].send({type:"ping"})}}),react__WEBPACK_IMPORTED_MODULE_0__.createElement("br",null),react__WEBPACK_IMPORTED_MODULE_0__.createElement("input",{type:"button",value:"increase remote counter",onClick:function(){return connections[key].send({type:"addNumber",number:1})}}),react__WEBPACK_IMPORTED_MODULE_0__.createElement("br",null),react__WEBPACK_IMPORTED_MODULE_0__.createElement("input",{type:"button",value:"decrease remote counter",onClick:function(){return connections[key].send({type:"addNumber",number:-1})}}),react__WEBPACK_IMPORTED_MODULE_0__.createElement("br",null),react__WEBPACK_IMPORTED_MODULE_0__.createElement("input",{type:"button",value:"add todo with state sync",onClick:function(){var newTodo={text:"new todo",id:Date.now()};actions.addTodo(newTodo),connections[key].send(_object_spread({type:"addTodo"},newTodo))}}))}))),react__WEBPACK_IMPORTED_MODULE_0__.createElement("br",null),react__WEBPACK_IMPORTED_MODULE_0__.createElement("br",null),children)}try{PeerProvider.displayName="PeerProvider",PeerProvider.__docgenInfo={description:"",displayName:"PeerProvider",props:{peerId:{defaultValue:null,description:"",name:"peerId",required:!0,type:{name:"any"}},config:{defaultValue:null,description:"",name:"config",required:!0,type:{name:"any"}},contacts:{defaultValue:null,description:"",name:"contacts",required:!0,type:{name:"any"}},contactId:{defaultValue:null,description:"",name:"contactId",required:!0,type:{name:"any"}},appiSchema:{defaultValue:null,description:"",name:"appiSchema",required:!0,type:{name:"any"}},state:{defaultValue:null,description:"",name:"state",required:!0,type:{name:"any"}},contentHash:{defaultValue:null,description:"",name:"contentHash",required:!0,type:{name:"any"}},actions:{defaultValue:null,description:"",name:"actions",required:!0,type:{name:"any"}},onConnection:{defaultValue:null,description:"",name:"onConnection",required:!0,type:{name:"any"}}}},"undefined"!=typeof STORYBOOK_REACT_CLASSES&&(STORYBOOK_REACT_CLASSES["src/stories/components/PeerProvider.tsx#PeerProvider"]={docgenInfo:PeerProvider.__docgenInfo,name:"PeerProvider",path:"src/stories/components/PeerProvider.tsx#PeerProvider"})}catch(__react_docgen_typescript_loader_error){}}}]);